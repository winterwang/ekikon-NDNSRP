---
title: "Mining the National Diet and Nutrition Survey Rolling Programme (NDNS RP) data"
subtitle: "Where, when, what you eat."
author: "王　超辰 | Chaochen Wang"
date: "2019-09-17 18:00~19:30 @AMU・疫学懇話会"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      countdown: 60000
      highlightStyle: github
      highlightLines: true
      highlightSpans: true
      countIncrementalSlides: false
---


```{r xaringan-themer, include = FALSE}
library(xaringanthemer)
mono_light(
  base_color = "#1c5253",
  header_font_google = google_font("Josefin Sans"),
  # text_font_google   = google_font("M PLUS Rounded 1c", "300", "300i"),
  text_font_google = google_font("Noto Sans JP", "300", "300i"), 
  code_font_google   = google_font("Droid Mono"),
  text_bold_color = "#B03A2E",
  link_color = "#2c7fb8",
  title_slide_background_image = "pic/",
  inverse_text_shadow = TRUE
)
# write_xaringan_theme(text_bold_color = "#FF4333")
```

class: middle

# Outline of today's talk 

--
### Correspondence analyses:


- Relationship between **food consumed** and **eating location** for UK adolescents


- Relationship between **food consumed** and **eating time** for UK adults according to their diabetes status 

--

### Multilevel Latent Class Analysis:

- Relationship between **carbohydrate consumption** and **eating time** for UK adults. 

---
class: middle

# Some intuition about correspondence analysis  (CA)

--
- CA is a method for investigating the relationship in a **two-dimensional contingency table**.

- For example, the following table gives the frequency of consumption of three healthy food groups at each location in the NDNS RP data among teenagers (age: 11~19 years):

```{r eval = T, echo=FALSE, message=FALSE}
library(knitr)
library(kableExtra)
library(tidyverse)
load("../CA-NDNSRP/H_teenFood.Rdata")

TableFoogGroup <- H_teenFood %>% 
  ungroup() %>% 
  group_by(mfgLab) %>% 
  summarise(n = n(), meanHpoint = mean(H_points, na.rm = T), mfgCalories = sum(Energykcal)) %>% 
  arrange(-mfgCalories) %>% 
  mutate(n.freq = paste0(round(100 * n/sum(n), 2), "%"))  %>% 
  mutate(cal.Prop = paste0(round(100 * mfgCalories/sum(mfgCalories), 2), "%"))  %>% 
  mutate(calprop = mfgCalories/sum(mfgCalories)) %>% 
  mutate(calcumprop = paste0(round(100 * cumsum(calprop), 3), "%")) %>% 
  select(-calprop) 


TableFoogGroup <- TableFoogGroup %>% 
  mutate(healthy     = meanHpoint < -2, 
         lesshealthy = meanHpoint > 4, 
         neutral     = (meanHpoint <= 4) & (meanHpoint >= -2))

# TableFoogGroup %>% 
#   filter(healthy) %>% 
#   select(-lesshealthy, -neutral, -calcumprop, -healthy)
healthyfg <- H_teenFood %>% 
  filter(mfgLab %in% c("Fruit", "Veg not raw", "Brown Bread"))
freqtab <- xtabs(~healthyfg$mfgLab + healthyfg$Locat_type)
freqtabmg <- addmargins(freqtab)
as.data.frame.matrix(freqtabmg) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  column_spec(1, bold = T) 
```


---
class: middle 

## Usually, we will conduct a $\chi^2$ test. 

```{r eval = T, echo=FALSE, message=FALSE}
as.data.frame.matrix(freqtabmg) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  column_spec(1, bold = T) 
```


$$
\chi^2 = \sum\frac{(\text{Observed} - \text{Expected})^2}{\text{Expected}} \sim \chi^2_{(m -1)\times(n-1)}
$$

--
### To look for evidence against the null hypothesis that **there is no difference across the columns or rows**.

---
class: middle
# Hypothesis of independence

The null hypothesis of no difference across the columns or rows is also called:

.pull-left[
- Hypothesis of independence 
]

.pull-right[
- Homogeneity assumption
]

```{r}
chisq.test(freqtab)
```


We conclude that **there is dependency between the columns (food groups) and the rows (locations)**. 

---
class: middle

## But what exactly does this dependency mean?


```{r eval = T, echo=FALSE, message=FALSE}
as.data.frame.matrix(freqtabmg) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))%>% 
  column_spec(1, bold = T) 
```

### Can we get **more information** from this contingency table? How?

--
### Yes! we can visualize their relationships!


---
class: middle 

## Step 1 - convert the frequency cell to proportions

```{r echo = FALSE}
Xp <- as.matrix(freqtab) / sum(as.matrix(freqtab))
Xpmg <- addmargins(Xp)
Xpmg <- signif(Xpmg, digits = 3)

Xp_4 <- sprintf("%.4f", Xpmg)
Xp_4 <- matrix(Xp_4, nrow = 4)
row.names(Xp_4) <- c("Brown Bread", "Fruit", "Veg not raw", "c: col masses")
colnames(Xp_4) <- c("Others", "Home", "School_work", "r: row masses")

as.data.frame.matrix(Xp_4) %>%
  kable(caption = "Matrix X. Observed Cell Proportions") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  column_spec(1, bold = T) 
```

- Row masses: $\mathbf{r} = \mathbf{X1}$ 

```{r}
r <- Xp %*% matrix(c(1, 1, 1), nrow = 3)
```

- Column masses: $\mathbf{c} = \mathbf{X}^T\mathbf{1}$

```{r}
c <- t(Xp)  %*% matrix(c(1, 1, 1), nrow = 3)
```

---
class: middle 
## Step 2 - The variation (residuals) of each cell in matrix X from its expected value

$$\text{Deviation} = \mathbf{X} - \mathbf{rc}^T$$

```{r echo=FALSE}
Deviation <- Xp - r %*% t(c)
library(formattable)
Deviation <- addmargins(Deviation)
Dev <- sprintf("%.5f", Deviation)
Dev <- matrix(Dev, nrow = 4)
rownames(Dev) <- rownames(Deviation)
colnames(Dev) <- colnames(Deviation)
as.data.frame.matrix(Dev) %>%
  kable(caption = "Deviations from Expected") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  column_spec(1, bold = T) 
```

Big positive (negative) numbers means a strong positive (negative) relationship.

???
The residuals quantify the difference between the observed data and the data we would expect under the assumption that there is no relationship between the row and column categories of the table.

---
class: middle 

## Step 3 - Calculate row profile, and column profile

.pull-left[

- Percentages of location for each food was eaten:

```{r echo=FALSE}
Dr <- diag(as.numeric(r))
Dc <- diag(as.numeric(c))
R <- solve(Dr) %*% Xp
C <- solve(Dc) %*% t(Xp)

Rmg <- addmargins(R)[-4,]
Rmg <- signif(Rmg, digits = 3)
rownames(Rmg) <- NULL

Rmg_4 <- sprintf("%.4f", Rmg)
Rmg_4 <- matrix(Rmg_4, nrow = 3)
rownames(Rmg_4) <- rownames(Rmg)
colnames(Rmg_4) <- colnames(Rmg)

as.data.frame.matrix(Rmg_4) %>%
  kable(caption = "Matrix R. Row Profile") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```
$$\mathbf{R} = \mathbf{D}^{-1}_r\mathbf{X}$$
]

.pull-right[
- Percentages of food was eaten at each location:

```{r echo = FALSE}
C <- solve(Dc) %*% t(Xp)

Cmg <- addmargins(t(C))[,-4]
Cmg <- signif(Cmg, digits = 3)
colnames(Cmg) <- c("Others", "Home", "School")



Cmg_4 <- sprintf("%.4f", Cmg)
Cmg_4 <- matrix(Cmg_4, nrow = 4)
rownames(Cmg_4) <- rownames(Cmg)
colnames(Cmg_4) <- colnames(Cmg)


as.data.frame.matrix(Cmg_4) %>%
  kable(caption = "Matrix C. Column Profile") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  column_spec(1, bold = T) 
```
$$\mathbf{C} = \mathbf{D}^{-1}_r\mathbf{X}^T$$

]
